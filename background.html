<script type="text/javascript">
// Set up the local variables & functions.
var liveSites = new Object();

// If there is no sites to make live, add one.
if(localStorage["liveSites"] == undefined){
	localStorage["liveSites"] = JSON.stringify(liveSites);
}
if(localStorage["LiveActions"] == undefined){
	localStorage["LiveActions"] = '#css,js';
}

liveSites = JSON.parse(localStorage["liveSites"]);
console.log('Can load up liveJS on: ');
console.log(liveSites);


// Adds the LiveJS to the page.
function Load_Live_JS(tab){
	//chrome.tabs.executeScript(tab.id, {code: 'if(document.getElementById("LivePage_LiveJS") === null){document.getElementsByTagName("body")[0].innerHTML += (\'<script type="text/javascript" id="LivePage_LiveJS" src="'+chrome.extension.getURL('live.js')+localStorage["LiveActions"]+'" ><\/script>\');}'});
	
	chrome.tabs.executeScript(tab.id, {code: "(function(){if(document.getElementById('LivePage_LiveJS') === null){var livejs = document.createElement('script');livejs.id = 'LivePage_LiveJS';livejs.src = '"+chrome.extension.getURL('live.js')+localStorage["LiveActions"]+"';livejs.type = 'text/javascript';document.body.appendChild(livejs);}})();"});
			
	chrome.browserAction.setBadgeText({text: "Live", tabId: tab.id});
	chrome.browserAction.setTitle({title: 'Disable LivePage on '+tab.url, tabId: tab.id});
	chrome.tabs.executeScript(tab.id, {file: 'real-live.js'});
	console.log('Loaded live JS on: '+tab.url);
}

// Removes the JS from the page.
function Skip_Live_JS(tab){
	chrome.browserAction.setBadgeText({text: "", tabId: tab.id});
	chrome.browserAction.setTitle({title: 'Enable LivePage on '+tab.url, tabId: tab.id});
	console.log('Skipped: '+tab.url);
}

// Add the listners
// Check if the URL were on has requested liveJS
chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
	// Only load it in when the page is loaded.
	if(changeInfo.status == "loading"){
		console.log('Checking: '+tab.url);
		
		if(liveSites[tab.url] === true){
			Load_Live_JS(tab);
		}else {
			Skip_Live_JS(tab);
		}
	}
});


// If the user clicks the icon - make the site liveJS enanabled/disabled
chrome.browserAction.onClicked.addListener(function(tab) {
	if(liveSites[tab.url]){
		delete liveSites[tab.url];
		Skip_Live_JS(tab);
		
		console.log('Deleting LiveJS: '+tab.url);
	} else{
		liveSites[tab.url] = true;
		
		// Load the liveJS when they click the butotn.
		Load_Live_JS(tab);
		
		console.log('Adding LiveJS: '+tab.url);
	}
	
	localStorage["liveSites"] = JSON.stringify(liveSites);
});
</script>